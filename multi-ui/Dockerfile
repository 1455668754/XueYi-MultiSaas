# åŸºç¡€é•œåƒ
FROM nginx
# author
MAINTAINER xueyi

# æŒ‚è½½ç›®å½•
VOLUME /home/xueyi/projects/xueyi-ui
# åˆ›å»ºç›®å½•
RUN mkdir -p /home/xueyi/projects/xueyi-ui
# æŒ‡å®šè·¯å¾„
WORKDIR /home/xueyi/projects/xueyi-ui
# å¤åˆ¶confæ–‡ä»¶åˆ°è·¯å¾„
COPY ./nginx/conf/nginx.conf /etc/nginx/nginx.conf
# å¤åˆ¶htmlæ–‡ä»¶åˆ°è·¯å¾„
COPY ./dist /home/xueyi/projects/xueyi-ui

# node æ„å»º
FROM node:16-alpine as build-stage
# author
MAINTAINER xueyi
# æŒ‚è½½ç›®å½•
VOLUME /home/xueyi/projects/xueyi-ui
# åˆ›å»ºç›®å½•
RUN mkdir -p /home/xueyi/projects/xueyi-ui
# æŒ‡å®šè·¯å¾„
WORKDIR /home/xueyi/projects/xueyi-ui
COPY . ./
# è®¾ç½® node é˜¿é‡Œé•œåƒ
RUN npm config set registry https://registry.npmmirror.com
# è®¾ç½®--max-old-space-size
ENV NODE_OPTIONS=--max-old-space-size=16384
# è®¾ç½®é˜¿é‡Œé•œåƒã€pnpmã€ä¾èµ–ã€ç¼–è¯‘
RUN npm install pnpm -g && \
    pnpm install --frozen-lockfile && \
    pnpm build:docker
# nodeéƒ¨åˆ†ç»“æŸ
RUN echo "ğŸ‰ ç¼– ğŸ‰ è¯‘ ğŸ‰ æˆ ğŸ‰ åŠŸ ğŸ‰"
# nginx éƒ¨ç½²
FROM nginx:1.23.3-alpine as production-stage
# å¤åˆ¶htmlæ–‡ä»¶åˆ°è·¯å¾„
COPY --from=build-stage /app/dist /home/xueyi/projects/xueyi-ui
# å¤åˆ¶confæ–‡ä»¶åˆ°è·¯å¾„
COPY --from=build-stage /app/nginx/conf/nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
## å°†/home/xueyi/projects/xueyi-ui/assets/index.js å’Œ/home/xueyi/projects/xueyi-ui/_app.config.jsä¸­çš„"$vg_base_url"æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ä¸­çš„VG_BASE_URL,$vg_sub_domain æ›¿æ¢æˆVG_SUB_DOMAINï¼Œ$vg_default_useræ›¿æ¢æˆVG_DEFAULT_USERï¼Œ$vg_default_passwordæ›¿æ¢æˆVG_DEFAULT_PASSWORD è€Œåå¯åŠ¨nginx
CMD sed -i "s|__vg_base_url|$VG_BASE_URL|g" /home/xueyi/projects/xueyi-ui/assets/entry/index-*.js /home/xueyi/projects/xueyi-ui/_app.config.js && \
    nginx -g 'daemon off;'
RUN echo "ğŸ‰ æ¶ ğŸ‰ è®¾ ğŸ‰ æˆ ğŸ‰ åŠŸ ğŸ‰"
